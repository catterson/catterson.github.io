---
title: "Lecture 11 - Multilevel Models (MLM)"
format: 
  html:
      code-overflow: wrap
---

## [Check-In : Let's GOOOOOOOOOO.](https://docs.google.com/forms/d/e/1FAIpQLSd8KDHkmmq-Lpd09Sagp7S_04LUKro4jaeNGmT0AZJCTtcJYg/viewform?usp=header)

![](images/clipboard-3900952240.png)

+--------------------------------------+--------------------------------------+
| **Graph A**                          | **Graph B**                          |
+--------------------------------------+--------------------------------------+
| ![](images/clipboard-1251750432.png) | ![](images/clipboard-4240830297.png) |
+--------------------------------------+--------------------------------------+

## Announcements

1.  **Final Project due....12/10?**
    -   [Pre-register your analyses](https://aspredicted.org)...did not mean to scare y'all!
        -   Think carefully and clearly about your dataset (outliers, measures, models)
        -   Be consistent in your analyses; keep things simple.
        -   When you deviate from your analysis plan, that's okay! You are learning and exploring. Just good to recognize and state this.
        -   **Review a few? Or y'all good?**
    -   **Next Week :** Draft of What Ya Got.
2.  **The End Is Near.**
    -   **TODAY :** Multilevel models.
    -   **THE END.** The Learning Has Stopped; Would You Like to Know More?

## Not a Lab 9

-   [**Professor Approach**](https://www.dropbox.com/scl/fi/mv995el36yv6q56nbhewg/Not-a-Lab-9-Professor-Key.pdf?rlkey=0gx0rj4ytxk7ry1wxefhdgliz&dl=0) **vs. Y'alls Work :** we did things differently!

    -   why is that okay / not a problem? :

    -   why is that not okay / a problem? :

-   **The Original Paper.**

![](images/clipboard-3302268801.png)

-   **Professor Attempt to Replicate**

![](images/clipboard-55299232.png){width="769"}

-   **Comments / Thoughts on the Article or the Analyses?**

    -   How effectively / well did the researcher address the question about dehumanizing language and attitudes about immigration?

    -   What other considerations (measures, methods, analyses, etc.) might the researcher have included if he wanted to really study dehumanization and immigration?

    -   What are our takeaways from this exercise?

## [Presentation](https://docs.google.com/presentation/d/1YZQ45_oj6TgiSIUpU7N6Ek5iTk2nn4T5RIpCz6Xi1K4/edit?usp=sharing)

## Multilevel Models (MLM) : Conceptual Understanding

### Definition

-   Multilevel Models (MLM)

    -   Also Called : Hierarchical linear models, mixed effects models, random effects models, etc.

    -   MODELS MODELS MODELS : It's just a line! Lots of lines. (Lots of lines models?)

-   Level 1 â€“\> Level ? :

    -   **Level 1 :** the smallest unit of analysis (where the DV is measured)

    -   **Level 2 :** where level 1 data is "nested"; Level 2 groups organize non-independent responses at Level 1.

### Some Examples of Multilevel Models

+---------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------+
| Visual Example                                    | Details                                                                                                                    |
+===================================================+============================================================================================================================+
| ![](images/clipboard-2317369415.png)              | Level 1 : Students in a school                                                                                             |
|                                                   |                                                                                                                            |
|                                                   | Level 2 : The school                                                                                                       |
|                                                   |                                                                                                                            |
|                                                   | **Why Non-Independence?**                                                                                                  |
|                                                   |                                                                                                                            |
|                                                   | -                                                                                                                          |
|                                                   |                                                                                                                            |
|                                                   | Source : [analyticsvidhya.com](https://www.analyticsvidhya.com/blog/2022/01/a-brief-introduction-to-multilevel-modelling/) |
+---------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------+
| ![](images/clipboard-4166772343.png)              | Level 1 : Participant data in a study.                                                                                     |
|                                                   |                                                                                                                            |
|                                                   | Level 2 : The results from a study.                                                                                        |
|                                                   |                                                                                                                            |
|                                                   | **Why Non-Independence?**                                                                                                  |
|                                                   |                                                                                                                            |
|                                                   | -                                                                                                                          |
|                                                   |                                                                                                                            |
|                                                   | Source : [Meta Analysis in R](https://bookdown.org/MathiasHarrer/Doing_Meta_Analysis_in_R/multilevel-ma.html)              |
+---------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------+
| ![](images/clipboard-3669224986.png){width="671"} | **Why Non-Independence?**                                                                                                  |
|                                                   |                                                                                                                            |
|                                                   | -                                                                                                                          |
|                                                   |                                                                                                                            |
|                                                   | Source : [Youtube video on HLM](https://www.youtube.com/watch?v=itxBT5rnxJ0)                                               |
+---------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------+

### Why These Models Matter?

+--------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------+
| "Fixed Effects"                      | "Random Effects"                                                                                                                  |
+======================================+===================================================================================================================================+
| ![](images/clipboard-2869584700.png) | [![](images/clipboard-3127063891.png)](https://www.r-bloggers.com/2020/11/simpsons-paradox-and-misleading-statistical-inference/) |
+--------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------+
| ![](images/clipboard-4032942124.png) | ![](images/clipboard-2789774520.png)                                                                                              |
+--------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------+

### The Formulas

-   **The Linear Model Equation**

$$\huge y = \beta_0 + \beta_1x_1 + ... + \beta_kx_k + \epsilon$$

-   **The MLM Equation (Level Notation)**

    ![](images/clipboard-4293194741.png)

    ![](images/clipboard-874488212.png)

### Why Are We Doing This?

1.  **The Assumption of Independence Has Been Violated! (MLM increases our power and reliability as scientists.)**
    -   Multiple measures of an individual gives you a more reliable estimate of what and who they are.
    -   A person serves as their own control; examining how an individual changes over time (as a result of some other variable or an experimental manipulation)
2.  **Better than a purely "fixed effects" approach.**
    -   While we *could* just account for group variation by adding this to our model as dummy-coded group identifiers...
    -   ...the MLM results in a simpler model (less coefficients; we just allow the intercepts and slopes to vary)
3.  **Model more complex phenomenon.**
    -   How people change over time (within-person variation).
    -   Simpson's Paradox
    -   Other Examples?

## How Do We Do This in R?

#### Example 1 : The Sleep Dataset

From the `?sleep` dataset; "Data which show the effect of two soporific drugs (increase in hours of sleep compared to control)."

-   Extra : increase in hours of sleep
-   Group : drug given (1 = control; 2 = drug)
-   ID : patient ID

##### The Linear Model (a "Between Person" Study)

```{r}
library(ggplot2)
ggplot(sleep, aes(y = extra, x = group)) + 
  geom_point(size=2) + 
  stat_summary(fun.data=mean_se, color = 'red', size = 1.25, linewidth = 2)

lmod <- lm(extra ~ as.factor(group), data = sleep)
summary(lmod)
```

##### The Linear Model, with ID as a grouping factor (a "Within-Person" Study)

Many linear models! Look at the graph below. What's going on? What do you observe? How might this help us understand the relationship between these two variables?

```{r}
ggplot(sleep, aes(y = extra, x = group, color = ID)) + 
  geom_point(size=2) + 
  geom_line(aes(group = ID), linewidth = 0.75)
```

Random Intercepts : Still just one equation. But a lot more lines!

```{r}
#install.packages("lme4")
library(lme4)
library(lmerTest)
library(Matrix)
mlmod <- lmer(extra ~ as.factor(group) + (1 | ID), data = sleep)
summary(mlmod)
```

-   **Fixed Effects :** The "Average" across all the grouping variables. Our friend the linear model!

    -   Intercept : ???? (discussed in lecture!)

    -   Slope : ???? (discussed in lecture!)

    -   Correlation of Fixed Effects : How our intercept and slope are related to each other. ????? (discussed in lecture!)

-   **Random Effects :**

    -   ICC = Intraclass Correlation Coefficient = how much the variation in our grouping variable (here : subject) explains total variation.

    -   To calculate : take variance of intercept / total variance

        ```{r}
        2.8483 / (2.8483 + 0.7564)
        ```

    -   OR :

        ```{r}
        library(performance)
        icc(mlmod)
        ```

**More about those random effects.** We can examine them for the individuals in the study. They are adjustments to the intercept (people start with different baselines of sleep.)

```{r}
fixef(mlmod)
ranef(mlmod)
var(ranef(mlmod)$ID)
```

##### But Professor, Where are the S\*\*\*s???

By default, lmer does not run statistical tests. I heard this was because the author of the package was philosophically opposed to them, but I think it's also because there are [continued debates](https://bbolker.github.io/mixedmodels-misc/glmmFAQ.html#why-doesnt-lme4-display-denominator-degrees-of-freedomp-values-what-other-options-do-i-have) about how best to calculate and interpret p-values for statistics that, by definition, can vary.

You can report confidence intervals from the results of the lmer model.

```{r}
confint(mlmod)
```

However, if you really want the stars, there's another package that adds the stars, and gives some other useful features.

```{r}
#install.packages("lmerTest")
library(lmerTest) # note that the function lmer from package lme4 has been masked.
mlmod <- lmer(extra ~ as.factor(group) + (1 | ID), data = sleep) # the same model; same equation
summary(mlmod) # new output!
ranova(mlmod) # a way to test whether inclusion of random effect improves the model fit or not.
detach("package:lmerTest") # won't be using this?
```

##### A Neat Thing : The "Paired T-Test" is Just a Narrow Form of the MLM

```{r}
d <- sleep # copying the data
sleepwide <- data.frame(d[1:10,1], d[11:20,1]) # moving into wide format
names(sleepwide) <- c("Extra1", "Extra2") # renaming variables
sleepwide # new data; in the "wide" format.
t.test(sleepwide$Extra1, sleepwide$Extra2, paired = T) # comparing mean of T1 to mean of T2, assuming a paired distribution....
```

##### What About Random Slopes?

For random intercepts and random slopes : Still just one equation....but....too many lines for the model to converge.

```{r}
#mlmod2 <- lmer(extra ~ as.factor(group) + (group | ID), data = sleep)
```

#### Example 2 : Another Sleep Dataset

A classic teaching dataset from lmer. Hooray!

```{r}
?sleepstudy
s <- sleepstudy
```

**A Question :** Is there a relationship between number of days of sleep deprivation and reaction time?

#### The Graph

How might we graph this in ggplot?

```{r}
library(ggplot2)
ggplot(sleepstudy, aes(y = Reaction, x = Days, color = Subject)) + 
  geom_point(size=2) + 
  # facet_wrap(~Subject) + 
  geom_smooth(method = "lm")
  # geom_line(aes(group = Subject), linewidth = 0.75)
```

#### Interpreting the Model (Random Intercepts)

What model would we define?

-   Reaction is the DV

-   I'm adding Days as a Fixed IV (so I'll get the average effect of \# of days of sleep deprivation on reaction time)

-   I'm also adding a random intercept : `(1 | Subject)` that will estimate how much the intercept (the 1 term) of individual raction times (the level 2 variable) varies by Subject (the level 1 grouping variable).

```{r}
library(lme4)
l2 <- lmer(Reaction ~ Days + (1 | Subject), data = sleepstudy)
summary(l2)
```

How do we interpret the results of this model?

-   **Fixed Effects :** these deal with the "average" effects - ignoring all those important individual differences (which are accounted for in the random effects.)

    -   Intercept = 251.41 = the average person's reaction time at 0 days of sleep deprivation is 251.4 milliseconds.

    -   Days = 10.47 = for every day of sleep deprivation, the average person's reaction time increases by 10.47 MS; the standard error is an estimate of how much variation we'd expect in this average slope due

-   **Random Effects :** these describe those individual differences; specifcally the

    -   Subject (Intercept) = 37.12

    -   Residual = 30.99

#### Interpreting the Model (Random Intercepts and Slopes)

**What model would we define?**

```{r}
lmer(Reaction ~ Days + (Days | Subject), data = sleepstudy)
```

How do we interpret the results of this model?

## Would You Like to Learn More?

-   [A Nice Overview, For and By Psychologists](https://www.learn-mlms.com)

-   [A More In-Depth Mini-Textbook](https://m-clark.github.io/mixed-models-with-R/introduction.html)

-   [A Nice Overview of the sleepstudy](https://cdsbasel.github.io/dataanalytics_rsessions/_sessions/CausalInference/intro_lme4.html)

-   TAKE A CLASS :

    -   [Sophia Rabe-Hasketh in the Education Department](http://www.gllamm.org/sophia.html#courses) \[Stata\]

    -   Aaron Fisher and / or Keenan Joyner is offering a class maybe? Unclear what the psych department is doing.

![](images/clipboard-3872254257.png)
